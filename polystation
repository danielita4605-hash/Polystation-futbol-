// mini_poly_func.c — Fútbol "PolyStation" ultrabásico, seccionado por funciones
// Reglas: sin offside, sin faltas, sin corners; goal kick si el atacante saca por línea de gol;
// gol si cruza meta; 2 tiempos cortos; formaciones fijas; portero con imán suave.

#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>

#define W 80            // ancho del campo
#define H 40            // alto del campo
#define N 5             // jugadores por equipo: 0=GK, 1..4 campo (mini)
#define TICKS_HALF 500  // duración de cada tiempo (ajustable)

typedef struct { int x, y; } Pos;

/* ======== Estado global (simple para mantener 1 archivo) ======== */
static Pos A[N], B[N];       // A = azules, B = rojos
static Pos ball;             // posición del balón
static int owner = -1;       // -1 libre; 0..4 A; 100..104 B
static int scoreA=0, scoreB=0;
static int half=1, ticks=0;
static int last_touch_team=0; // 0=A, 1=B

// Metas (rectángulos)
static const int goalL_xmin=0,   goalL_xmax=1,   goalL_ymin=H/2-4, goalL_ymax=H/2+4;     // defiende A
static const int goalR_xmin=W-2, goalR_xmax=W-1, goalR_ymin=H/2-4, goalR_ymax=H/2+4;     // defiende B

/* ================= Utilidades ================= */
static int clamp(int v, int lo, int hi){ if(v<lo) return lo; if(v>hi) return hi; return v; }
static bool inrect(int x,int y,int xmin,int xmax,int ymin,int ymax){
    return x>=xmin && x<=xmax && y>=ymin && y<=ymax;
}

/* ================= Núcleo del juego ================= */
// 1) Formaciones fijas
static void set_formation(int code){
    // GK centrados
    A[0]=(Pos){3, H/2};        B[0]=(Pos){W-4, H/2};
    if(code==1){ // variante
        A[1]=(Pos){15, 10}; A[2]=(Pos){15, 20}; A[3]=(Pos){15, 30}; A[4]=(Pos){25, 20};
        B[1]=(Pos){W-16, 10}; B[2]=(Pos){W-16, 20}; B[3]=(Pos){W-16, 30}; B[4]=(Pos){W-26, 20};
    }else{       // líneas más simples
        A[1]=(Pos){12,  8}; A[2]=(Pos){12, 16}; A[3]=(Pos){12, 24}; A[4]=(Pos){12, 32};
        B[1]=(Pos){W-13,  8}; B[2]=(Pos){W-13, 16}; B[3]=(Pos){W-13, 24}; B[4]=(Pos){W-13, 32};
    }
}

// 2) Saque inicial
static void kickoff(void){
    owner=-1;
    ball.x=W/2; ball.y=H/2;
}

// 3) Saque de puerta
static void goal_kick(int defending){ // 0=A, 1=B
    if(defending==0){ A[0].x = 4; A[0].y = H/2; ball = A[0]; owner = 0;    }
    else            { B[0].x = W-5; B[0].y = H/2; ball = B[0]; owner = 100;}
}

// 4) Imán del portero en área chica
static void gk_magnet(void){
    // Área chica A (izquierda) y B (derecha)
    int axmin=0, axmax=5, aymin=H/2-5, aymax=H/2+5;
    int bxmin=W-6, bxmax=W-1, bymin=H/2-5, bymax=H/2+5;

    if(inrect(ball.x, ball.y, axmin, axmax, aymin, aymax)){
        if(abs(A[0].x - ball.x)<=1 && abs(A[0].y - ball.y)<=1){ owner=0; ball=A[0]; }
    }else if(inrect(ball.x, ball.y, bxmin, bxmax, bymin, bymax)){
        if(abs(B[0].x - ball.x)<=1 && abs(B[0].y - ball.y)<=1){ owner=100; ball=B[0]; }
    }
}

// 5) Reglas de salida/gol
static void check_goal_or_out(void){
    // Gol
    if(inrect(ball.x, ball.y, goalL_xmin, goalL_xmax, goalL_ymin, goalL_ymax)){ scoreB++; kickoff(); return; }
    if(inrect(ball.x, ball.y, goalR_xmin, goalR_xmax, goalR_ymin, goalR_ymax)){ scoreA++; kickoff(); return; }

    // Laterales: sin banda -> pegar al borde
    if(ball.y < 0){ ball.y=0; owner=-1; }
    if(ball.y >= H){ ball.y=H-1; owner=-1; }

    // Línea de gol: sin corner; goal kick si atacante fue el último en tocar
    if(ball.x < 0){ // izquierda (defiende A)
        if(last_touch_team==1){ goal_kick(0); return; }
        ball.x=0; owner=-1;
    }
    if(ball.x >= W){ // derecha (defiende B)
        if(last_touch_team==0){ goal_kick(1); return; }
        ball.x=W-1; owner=-1;
    }
}

/* ================== Acciones (cada una en su función) ================== */
// Opción 1: iniciar/reiniciar
static void cmd_kickoff(void){ kickoff(); }

// Opción 2: mover jugador
static void cmd_move_player(int pid, int dx, int dy){
    if(pid>=0 && pid<N){ // A
        A[pid].x = clamp(A[pid].x+dx, 0, W-1);
        A[pid].y = clamp(A[pid].y+dy, 0, H-1);
        if(owner==pid) ball = A[pid];
    }else if(pid>=100 && pid<100+N){ // B
        int i = pid-100;
        B[i].x = clamp(B[i].x+dx, 0, W-1);
        B[i].y = clamp(B[i].y+dy, 0, H-1);
        if(owner==pid) ball = B[i];
    }
    gk_magnet();
}

// Opción 3: pase
static void cmd_pass_ball(int from, int to){
    if(owner!=from) return; // debe tenerla quien pasa
    if(to<0 || (to>=N && to<100) || to>=100+N) return; // id inválido
    ball = (to<100)? A[to] : B[to-100];
    owner = to;
    last_touch_team = (to<100)? 0 : 1;
    gk_magnet();
}

// Opción 4: chutar (deja libre el balón)
static void cmd_shoot(int dx, int dy){
    if(owner!=-1) last_touch_team = (owner<100)? 0 : 1;
    ball.x += dx; ball.y += dy; owner = -1;
    check_goal_or_out();
    gk_magnet();
}

// Opción 5: avanzar tiempo
static void cmd_tick(void){
    ticks++;
    if(ticks >= TICKS_HALF){
        ticks = 0;
        if(half==1){ half=2; kickoff(); }
        else { printf("Fin del partido.\n"); }
    }
}

// Opción 6: imprimir estado
static void cmd_print_state(void){
    printf("\nA %d - %d B | Tiempo %d/%d (H%d)\n", scoreA, scoreB, ticks, TICKS_HALF, half);
    printf("Ball (%d,%d) owner:%d\n", ball.x, ball.y, owner);
    printf("A: GK(%2d,%2d) 1(%2d,%2d) 2(%2d,%2d) 3(%2d,%2d) 4(%2d,%2d)\n",
        A[0].x,A[0].y,A[1].x,A[1].y,A[2].x,A[2].y,A[3].x,A[3].y,A[4].x,A[4].y);
    printf("B: GK(%2d,%2d) 1(%2d,%2d) 2(%2d,%2d) 3(%2d,%2d) 4(%2d,%2d)\n",
        B[0].x,B[0].y,B[1].x,B[1].y,B[2].x,B[2].y,B[3].x,B[3].y,B[4].x,B[4].y);
}

// Opción 7: formar 4-3-3
static void cmd_form_433(void){ set_formation(1); cmd_kickoff(); cmd_print_state(); }

// Opción 8: formar 4-4-2
static void cmd_form_442(void){ set_formation(0); cmd_kickoff(); cmd_print_state(); }

/* ================== Setup simple ================== */
static void bootstrap(void){
    set_formation(0); // arranque 4-4-2
    kickoff();
}

/* ================== Menú / loop ================== */
static void print_menu(void){
    printf("\n==== MINI POLY (funciones) ====\n");
    printf("1) Kickoff (iniciar/reiniciar)\n");
    printf("2) Mover jugador  (pid dx dy)  pid: A=0..4, B=100..104\n");
    printf("3) Pasar balon    (from to)\n");
    printf("4) Chutar balon   (dx dy)\n");
    printf("5) Tick (avanzar tiempo)\n");
    printf("6) Mostrar estado\n");
    printf("7) Formacion 4-3-3\n");
    printf("8) Formacion 4-4-2\n");
    printf("0) Salir\n> ");
}

int main(void){
    bootstrap();
    cmd_print_state();

    while(1){
        print_menu();
        int op; if(scanf("%d",&op)!=1) break;
        if(op==0) break;

        if(op==1){
            cmd_kickoff();
        }else if(op==2){
            int pid,dx,dy; printf("pid dx dy: ");
            if(scanf("%d %d %d",&pid,&dx,&dy)==3) cmd_move_player(pid,dx,dy);
        }else if(op==3){
            int a,b; printf("from to: ");
            if(scanf("%d %d",&a,&b)==2) cmd_pass_ball(a,b);
        }else if(op==4){
            int dx,dy; printf("dx dy: ");
            if(scanf("%d %d",&dx,&dy)==2) cmd_shoot(dx,dy);
        }else if(op==5){
            cmd_tick();
        }else if(op==6){
            cmd_print_state();
        }else if(op==7){
            cmd_form_433();
        }else if(op==8){
            cmd_form_442();
        }
    }
    return 0;
}